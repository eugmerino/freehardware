{% extends 'base.html' %}

{% block title %}Registro - 
{% if config and config.name %}
    {{ config.name }}
{% else %}
    Proyectos Hardware Libre
{% endif %}
{% endblock %}

{% block content %}
<h1>Agregar Proyecto</h1>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Paso 1: Título y Descripción -->
    <div class="form-step" id="step-1">
        <h3>Paso 1:</h3>
        <div class="mb-3">
            {{ form.title.label_tag }}
            {{ form.title }}
        </div>
        <div class="mb-3">
            {{ form.description.label_tag }}
            {{ form.description }}
        </div>
    </div>

    <!-- Paso 2: Código y Diagrama -->
    <div class="form-step" id="step-2" style="display: none;">
        <h3>Paso 2:</h3>
        <div class="mb-3">
            {{ form.code.label_tag }}
            {{ form.code }}
        </div>
        <div class="mb-3">
            {{ form.imgDiagram.label_tag }}
            {{ form.imgDiagram }}
        </div>
    </div>

    <!-- Paso 3: Componentes -->
    <div class="form-step" id="step-3" style="display: none;">
        <h3>Paso 3:</h3>
        <div class="mb-5">
            <div>
                <label for="form-label">Componentes:</label>
            </div>
            <div id="component-container">
                <div id="component-1">
                    <label>Seleccionar componente:</label>
                    <select name="component_id" class="form-control">
                        {% for component in components %}
                            <option value="{{ component.id }}">{{ component.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="amount" placeholder="Cantidad" class="form-control mt-2">
                    <textarea name="description" placeholder="Descripción" class="form-control mt-2"></textarea>
                    <button type="button" class="btn btn-danger mt-2" onclick="removeComponent(1)">Eliminar</button>
                </div>
            </div>
            <button type="button" id="add-component-btn" class="btn btn-secondary mt-2">Agregar Componente</button>
            <button type="button" class="btn btn-secondary mt-2 d-block" data-bs-toggle="modal" data-bs-target="#addComponentModal">
                Agregar Componente
            </button>
        </div>
    </div>

    <!-- Paso 4: Imágenes -->
    <div class="form-step" id="step-4" style="display: none;">
        <h3>Paso 4:</h3>
        <div class="mb-3">
            <label for="form-label">Imágenes del proyecto:</label>
        </div>
        {{ formset.management_form }}
        <div id="formset-container">
            {% for form in formset %}
                <div class="mb-3 form-inline">
                    {{ form.image.label_tag }}
                    {{ form.image }}
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-image-btn" class="btn btn-secondary mt-3">Agregar otra imagen</button>
    </div>

    <!-- Botones de navegación -->
    <div class="form-navigation mt-4">
        <button type="button" class="btn btn-secondary" id="prev-step" style="display: none;">Anterior</button>
        <button type="button" class="btn btn-primary" id="next-step">Siguiente</button>
        <button type="submit" class="btn btn-success" id="submit-form" style="display: none;">Guardar Proyecto</button>
    </div>
</form>

<!-- Modal para agregar componente -->
<div class="modal fade" id="addComponentModal" tabindex="-1" aria-labelledby="addComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addComponentModalLabel">Agregar Nuevo Componente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addComponentForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ component_form.as_p }}
                    <button type="submit" class="btn btn-primary">Guardar Componente</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Script AJAX para agregar el componente sin recargar la página -->
<script>
    // Script para manejar los pasos del formulario
    let currentStep = 1;
    const totalSteps = 4;

    function showStep(step) {
        for (let i = 1; i <= totalSteps; i++) {
            document.getElementById(`step-${i}`).style.display = i === step ? "block" : "none";
        }
        document.getElementById('prev-step').style.display = step === 1 ? "none" : "inline-block";
        document.getElementById('next-step').style.display = step === totalSteps ? "none" : "inline-block";
        document.getElementById('submit-form').style.display = step === totalSteps ? "inline-block" : "none";
    }

    document.getElementById('next-step').addEventListener('click', () => {
        if (currentStep < totalSteps) {
            currentStep++;
            showStep(currentStep);
        }
    });

    document.getElementById('prev-step').addEventListener('click', () => {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    // Inicializar mostrando el primer paso
    showStep(currentStep);

    // Manejo de agregar componente dinámicamente
    let componentCount = 1;

    document.getElementById('add-component-btn').addEventListener('click', () => {
        componentCount++;
        const newComponentHtml = `
            <div id="component-${componentCount}">
                <label>Seleccionar componente:</label>
                <select name="component_id" class="form-control">
                    {% for component in components %}
                        <option value="{{ component.id }}">{{ component.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="amount" placeholder="Cantidad" class="form-control mt-2">
                <textarea name="description" placeholder="Descripción" class="form-control mt-2"></textarea>
                <button type="button" class="btn btn-danger mt-2" onclick="removeComponent(${componentCount})">Eliminar</button>
            </div>
        `;
        document.getElementById('component-container').insertAdjacentHTML('beforeend', newComponentHtml);
    });

    function removeComponent(id) {
        document.getElementById(`component-${id}`).remove();
    }

    // AJAX para agregar un nuevo componente
document.getElementById('addComponentForm').onsubmit = function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("{% url 'register' %}", {
        method: "POST",
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Seleccionar todos los select con el nombre "component_id"
            const selects = document.querySelectorAll('select[name="component_id"]');
            const option = new Option(data.component_name, data.component_id);

            // Agregar la nueva opción a cada select
            selects.forEach(select => {
                select.add(option.cloneNode(true));  // Usar cloneNode para agregar la opción a cada select
            });

            alert('Componente agregado con éxito');
            this.reset();
        } else {
            alert('Error al agregar el componente');
        }
    })
    .catch(error => console.error('Error:', error));
};


    // Manejo de imágenes dinámicas en el formulario
    document.getElementById("add-image-btn").addEventListener("click", function () {
        const currentFormCount = parseInt(document.querySelector("[name='projectimage_set-TOTAL_FORMS']").value);
        const newFormHtml = `
            <div class="mb-3 form-inline">
                <label for="id_projectimage_set-${currentFormCount}-image">Imagen:</label>
                <input type="file" name="projectimage_set-${currentFormCount}-image" class="form-control">
            </div>
        `;
        document.getElementById("formset-container").insertAdjacentHTML('beforeend', newFormHtml);
        document.querySelector("[name='projectimage_set-TOTAL_FORMS']").value = currentFormCount + 1;
    });
</script>

{% endblock %}
